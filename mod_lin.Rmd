---
title: "Modelo Lineal Simple"
author: Bladimir Morales Torrez
date: "01 de Agosto 2020"
output: 
  html_notebook:
    number_sections: true
    theme: darkly
    toc: true
    toc_float: true
    fig_retina: 2
    df_print: paged
    code_folding: hide
---

```{r setup,include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
library(dplyr)
library(reshape2)
library(readxl)
library(ggplot2)
library(highcharter)
#rm(list=ls())
```

Las librerias a utilizar en R.

```{r librerias,eval=FALSE}
library(dplyr)
library(reshape2)
library(readxl)
library(ggplot2)
library(highcharter)
#rm(list=ls())
```

En este documento se pretende calcular un modelo de regresión lineal simple para dos variables cuantitativas:

* **Esperanza de Vida**: variable respuesta o dependiente $Y$ (endógena, explicada).

* **Tasa de analfabetismo**: variable predictora o independiente $X$ (exógena, explicativa).

# Datos

Los datos utilizados son del [Banco Mundial](https://datos.bancomundial.org/):

* [Esperanza de vida](https://datos.bancomundial.org/indicator/SP.DYN.LE00.IN) para el año 2018.

```{r datos_evida}
evida=read_xls("C:/Users/Bladimir/Documents/Proyectos/modelos_estadisticos/BD/esperanzavida.xls") %>% 
  select(pais,cod_pais,evida_2018="2018") 
evida
```


* [Tasa de Analfabetismo](https://datos.bancomundial.org/indicator/SE.ADT.LITR.ZS) para el año 2018.


```{r datos_analfabetismo}
analfabetismo=read_xls("C:/Users/Bladimir/Documents/Proyectos/modelos_estadisticos/BD/analfabetismo.xls") %>% 
  select(pais,cod_pais,analfabetismo_2018="2018")
analfabetismo

```


Hacemos una union de las dos bases de datos eliminando primero los datos vacios (NA).

```{r bd}
evida=evida %>% 
  dplyr::filter(!is.na(evida_2018))

analfabetismo=analfabetismo %>% 
  dplyr::filter(!is.na(analfabetismo_2018))

bd=inner_join(analfabetismo,evida) 

bd
```

# Análisis de variables

## Correlación entre variables

Se utilizará el coeficiente de correlación de Pearson:

$$r=\frac{Cov(X,Y)}{\sigma_x  \sigma_y} $$

El valor de $r$ solo puede estar entre el intervalo de $(-1,\;1)$ debido al signo de la covarianza y para calificar la correlación de dos variables cuantitativas se utiliza la siguiente escala en valor absoluto de $|r|$:


<center>**Escala de Correlación de Pearson**
```{r escala_pearson,echo=FALSE}
data.frame(r=c("0 - 0.3","0.3 - 0.6","0.6 - 0.9 ","0.9 - 0.95","1"),
           Escala=c("Baja","Regular","Alta","Significativamente alta","Funcional"))
```

Se debe analizar la correlación entre variables en este caso sera la tasa de analfabetismo $Y$ y la esperanza de vida $X$.



```{r correlacion}
r=cor.test(bd$evida_2018,bd$analfabetismo_2018)
r
```

Se observa que existe un alto grado de correlación positiva de Pearson 
$$r= `r r$estimate`$$

## Dispersograma

El diagrama de dispersión o dispersograma es el gráfico en un plano cartesiano donde el eje $X$ representa a la tasa deanalfabetismo y el eje $Y$ la esperanza de vida.

```{r dipersograma}
bd1=melt(bd)
hchart(bd,type="scatter",hcaes(x=analfabetismo_2018,y=evida_2018,group=pais)) %>% 
  hc_legend() %>% 
  hc_title(text="Dispersograma del Analfabetismo y Esperanza de Vida") %>% 
  hc_subtitle(text="Países del Mundo 2018") %>% 
  hc_xAxis(title=list(text="Analfabetismo")) %>% 
  hc_yAxis(title=list(text="Esperanza de vida")) %>% 
  hc_add_theme(hc_theme_darkunica())


```

```{r}
ggplot(bd,aes(x=tasa_analfab_2018,y=esp_vida_2018))+
  geom_point()+
  labs(title="Dispersograma",
       caption = "Datos Banco Mundial 2018",
       y="Esperanza de vida",
       x="Tasa de analfabetismo")
```

Se observa que efectivamente existe una correlación positiva entre las variables vale decir que mientras una crece la otra también.

# Modelo de Regresión Lineal Simple

Para el modelo de regresión lineal simple se tendrá solamente dos variables $y_i$ (dependendiente) y $x_i$ (independiente), y esta representado:

$$y_i=\beta_0+\beta_1 x_i+\epsilon_i$$
Donde:

- $y_i$ variable dependiente, endógena, respuesta o explicada.
- $x_i$ variable independiente, exógena, predictora o explicativa.
- $\beta_0$ coeficiente intercepto de la línea con el eje $y$.
- $\beta_1$ coeficiente pendiente de la línea de regresión.
- $\epsilon_i$ errores aleatorios.

Si desarrollamos el modelo para cada observación se tiene las siguientes ecuaciones:

$$\begin{aligned}
y_1&=\beta_0+\beta_1x_1+\epsilon_1\\
y_2&=\beta_0+\beta_1x_1+\epsilon_2\\
\vdots &\hspace{1.5cm}\vdots\hspace{1.5cm}\vdots \\
y_n&=\beta_0+\beta_1x_1+\epsilon_n\\
\end{aligned}
$$

El sistema de ecuaciones equibale matricialmente:

\begin{equation}
\left[\begin{array}{c}
y_1 \\ 
y_2 \\ 
\vdots \\
y_n
\end{array}\right]
=
\left[\begin{array}{cc}
1 & x_1\\
1 & x_2\\
\vdots & \vdots\\
1 & x_n\\
\end{array}\right]

\left[\begin{array}{c}
\beta_0\\
\beta_1
\end{array}\right]
+
\left[\begin{array}{c}
\epsilon_1\\
\epsilon_2\\
\vdots\\
\epsilon_n\\
\end{array}\right]
\end{equation}

Entonces el modelo de regresión lineal simple de manera matricial es:

$$Y=X\beta+\epsilon$$

Supuestos:

$$\epsilon_i \sim iid \; N(0\;,\sigma^2) $$
- $iid$ independiente e identicamente distribuidos.

Si hallamos la esperanza de $y_i$:

$$
\begin{aligned}
E(y_i|x_i)&=E(\beta_0+\beta_1 x_i+\epsilon_i)\\
          &=E(\beta_0)+E(\beta_1 x_i)+ E(\epsilon_i)\hspace{1cm} ;\beta_0,\beta_1,x_i=cttes. \\
          &=\beta_0+\beta_1x_i+0\\
          &=\beta_0+\beta_1x_i
\end{aligned}
$$

$$\begin{aligned}
Var(y_i|x_i)&=Var(\beta_0+\beta_1 x_i+\epsilon_i)\hspace{1cm} ;\beta_0,\beta_1,x_i=cttes. \\ 
            &=Var(\epsilon_i)\\
            &=\sigma^2
\end{aligned}
$$

Por lo tanto:

$$y_i|x_i\sim N(\beta_0+\beta_1x_i\; ; \; \sigma^2)$$

Entonces continuando con los datos del banco mundial en  el análisis de variables se concluyó que efectivamente las dos variables tienen correlación positiva, entonces se estima el modelo de regresión lineal simple.

$$Y=X\beta+\epsilon$$


## Coeficientes del modelo

Los coeficientes del modelo de regresión lineal simple vale decir $\beta_0$ y $\beta_1$ deben ser estimados es por eso que se utiliza los mínimos cuadrados ordinarios MCO.

Se parte del modelo de regresión lineal.

$$y_i=\beta_0+\beta_1 x_i+ \epsilon_i$$

Donde igualamos la suma de la parte aleatoria al cuadrado del modelo a una función $Q$ que depende de $\beta_0$ y $\beta_1$:

$$\begin{aligned}
Q(\beta_0,\beta_1)&=\sum_{i=1}^n \epsilon_i^2\\
                  &=\sum_{i=1}^n (y_i-\beta_0-\beta_1 x_i)^2\\
\end{aligned}
$$

Ahora derivamos $Q$ con respecto a $\beta_0$ y $\beta_1$

$$\begin{aligned}
\frac{\partial Q}{\partial\beta_0}&=\sum_{i=1}^n 2(y_i-\beta_0-\beta_1 x_i)(-1)\\
\frac{\partial Q}{\partial\beta_1}&=\sum_{i=1}^n 2(y_i-\beta_0-\beta_1 x_i)(-x_i)\\
\end{aligned}
$$
Igualamos a cero para minimizar

$$\begin{aligned}
\frac{\partial Q}{\partial\beta_0}&=0\\
\frac{\partial Q}{\partial\beta_1}&=0\\
\end{aligned}
$$

Entonces

$$\begin{aligned}
\sum_{i=1}^n 2(y_i-\hat{\beta_0}-\hat{\beta_1} x_i)(-1)&=0\\
\sum_{i=1}^n 2(y_i-\hat{\beta_0}-\hat{\beta_1} x_i)(-x_i)&=0\\
\end{aligned}
$$
Luego el se multiplica las dos ecuaciones por $(\frac{1}{2})$:

$$
\begin{aligned}
-\sum_{i=1}^n y_i + n\hat{\beta_0} + \hat{\beta_1} \sum_{i=1}^nx_i=0\\
-\sum_{i=1}^n x_i y_i + \hat{\beta_0} \sum_{i=1}^n x_i + \hat{\beta_1} \sum_{i=1}^n x_i^2=0\\
\end{aligned}
$$

Primero despejamos $\beta_0$ de la primera ecuación:

$$\begin{aligned}
n\hat{\beta_0} &=\sum_{i=1}^n y_i - \hat{\beta_1} \sum_{i=1}^n x_i\\
\hat{\beta_0} &=\sum_{i=1}^n \frac{y_i}{n} - \hat{\beta_1} \sum_{i=1}^n \frac{x_i}{n}\\
\hat{\beta_0} &=\overline{y} - \hat{\beta_1} \overline{x}\\
\end{aligned}
$$

Reemplazamos el estimador $\hat{\beta_0}$ en la segunda ecuación de $\hat{\beta_1}$

$$\begin{aligned}
\hat{\beta_1} \sum_{i=1}^n x_i^2&=\sum_{i=1}^n x_i y_i - \hat{\beta_0} \sum_{i=1}^n x_i \\
\hat{\beta_1} \sum_{i=1}^n x_i^2&=\sum_{i=1}^n x_i y_i - (\overline{y} - \hat{\beta_1} \overline{x}) \sum_{i=1}^n x_i \\
\hat{\beta_1} \sum_{i=1}^n x_i^2&=\sum_{i=1}^n x_i y_i - \overline{y} \sum_{i=1}^n x_i + \hat{\beta_1} \overline{x} \sum_{i=1}^n x_i \\
\hat{\beta_1} \sum_{i=1}^n x_i^2 -  \hat{\beta_1} \overline{x} \sum_{i=1}^n x_i&=\sum_{i=1}^n x_i y_i - \overline{y} \sum_{i=1}^n x_i  \\
\hat{\beta_1}(\sum_{i=1}^n x_i^2 -  \overline{x} \sum_{i=1}^n x_i)&=\sum_{i=1}^n x_i y_i - \overline{y} \sum_{i=1}^n x_i  \hspace{0.5cm};(\frac{1}{n}) \\
\hat{\beta_1}(\frac{\sum_{i=1}^n x_i^2}{n} -  \overline{x}^2)&=\frac{\sum_{i=1}^n x_i y_i}{n} - \overline{y} \overline{x}\\
\hat{\beta_1}(\sigma_x^2) &= cov(x,y)\\
\hat{\beta_1} &= \frac{cov(x,y)}{\sigma_x^2}\\
\end{aligned}
$$

Para nuestro modelo son los siguientes coeficientes del modelo lineal

```{r modelo_lin}
mod=lm(evida_2018~analfabetismo_2018,data=bd)
#Coeficientes del modelo lineal
summary(mod)
```

El modelo de regresión lineal será:

$$\text{Esp_vida}_i= `r mod$coefficients[1]` + `r mod$coefficients[2]`* \text{tasa_analfabetismo}_i
$$

Interpretación:

-$\beta_0$= `r mod$coefficients[1]` es el valor promedio de la variable respuesta $Y$ cuando $X$ es cero.

.$\beta_1$= `r mod$coefficients[2]` indica el cambio promedio en la variable respuesta $Y$ cuando $X$ se incrementa en una unidad.


## Descomposición de la varianza total del modelo lineal

Para la regresión lineal se tiene la descomposición de la varianza de la variable dependiente $y$:

$$Var. \;total \;Y = Var.\; de\; la\; regresión + Var.\; del\; error$$

Se parte de la Varianza

$$Var(Y)=\sum_{i=1}^n \frac{1}{n}(y_i-\overline y)^2$$

Entonces multiplicamos por $(n)$

$$\begin{aligned}
\sum_{i=1}^n (y_i-\overline y)^2&=\sum_{i=1}^n (y_i-\hat y_i+\hat y_i-\overline y)^2\\
\sum_{i=1}^n (y_i-\overline y)^2&=\sum_{i=1}^n (\hat y_i-\overline y)^2+ \sum_{i=1}^n(y_i-\hat y_i)^2\\
SCT&=SCReg+SCRes\\
\end{aligned}$$

Si todas las dividimos por $\sigma^2$ tendrán distribución $\chi^2$.

## Análisis de Varianza (ANOVA)

Se desea saber si la variable explicativa o independiente $X$ influye significativamente sobre la variable $Y$. Para esto se tiene el siguiente contraste de hipótesis.

$$H_0:\; \beta_0=0\;\;(X \text{ no influye})\\
H_1:\; \beta_0 \neq 0 \;\;(X \text{ influye})
$$
Se debe cumplir el siguiente estadístico:

$$CMReg=\frac{SCReg}{g.l.}=\frac{SCReg}{1}\\
CMRes=\frac{SCRes}{g.l.}=\frac{SCReg}{n-2}
$$
Donde: 

-$CMReg$ : Cuadrado medio de la regresión
-$CMRes$ : Cuadrado medio de los residuos

La decición de aceptar o rechazar $H_0$ se va a tomar en base al estadístico que se obtiene a partir de análisis de varianza, que tiene una distribución $F$ con $(1;n-2)$ grados de libertad bajo $H_0$ por lo tanto la regla de decisión es la siguiente, se rechaza $H_0$ al nivel de significancia $\alpha$ cuando:

$$
F_c=\frac{CMReg}{CMRes}>F
$$
O también se rechaza $H_0$ si:

$$
p-valor<0.05
$$


```{r prueba_hipotesis_b1}
#Prueba de hipótesis de coeficientes
anova(mod)
```

En el estimador de $\beta_1$ se ve que su $p-valor \;<\;0.05$ por lo tanto se rechaza $H_0:\; \beta_1=0$. 

## Intervalo de confianza para los parámetros de la regresión

El intervalo de confianza es:

$$
\hat{\beta_1}\pm t_{(1-\frac{\alpha}{2};n-2)} \frac{S}{\sqrt{n\sigma^2}}
$$
```{r ic_parametros}
confint(mod,level=0.95)
```

## El coeficiente de Determinación 

Es el cuadrado del coeficiente de correlación de Pearson $r^2=R^2$

$$r=\frac{Cov(X,Y)}{\sigma_x  \sigma_y} $$

O también es equivalente:

$$R^2=\frac{SCReg}{SCT}=1-\frac{SCRes}{SCT}=r_{xy}^2$$

Como $-1<r<1$ entonces $0<R^2<1$

$R^2$ es interpretado como la proporción de variabilidad de la variable respuesta $Y$, que es explicada por su relación lineal con $X$


```{r}
summary(mod)
```

## Intervalo de confianza para el valor medio de las predicciones de Y

El intervalo de confianza para el valor medio de todos los valores de $Y$ dado que $X=x_0$ o escrito de manera formal $E(Y|X=x_0)$ es:

$$\hat{y}\pm t_{(1-\frac{\alpha}{2};n-2)}S\sqrt{\frac{1}{n}+\frac{(x_0-\overline{x})^2}{n\sigma^2}} $$
Si queremos tener en particular una tasa de analfabetismo $x_0=85$ se puede estimar el intervalo de confianza del $95\%$ para la esperanza de vida media.

```{r int_mediay}
x0analfabetismo=data.frame(analfabetismo_2018=85)
predict(mod,newdata = x0analfabetismo,interval = "confidence")
```
## Intervalo de confianza para un valor individual de las Y

El intervalo de confianza para un valor individual de $Y$ dado que $X=x_0$ o escrito de manera formal $E(Y|X=x_0)$ es:

$$\hat{y_0}\pm t_{(1-\frac{\alpha}{2};n-2)}S\sqrt{1+\frac{1}{n}+\frac{(x_0-\overline{x})^2}{n\sigma^2}} $$

Si queremos tener en particular una tasa de analfabetismo $x_0=85$ se puede estimar el intervalo de confianza del $98\%$ para el valor predicho de la esperanza de vida $\hat{y_0}$.

```{r int_y}
x0analfabetismo=data.frame(analfabetismo_2018=85)
predict(mod,newdata = x0analfabetismo,interval = "prediction",level=0.98)
```

## Gráfico de intervalo de confianza

```{r graf_int}
pred_mod=predict(mod,interval = "confidence")
pred_mod1=predict(mod,interval = "prediction")
bd_pred=cbind(bd,pred_mod,pred_mod1)
names(bd_pred)=c("pais","cod_pais","analfabetismo_2018","evida_2018","fit","inf_media","sup_media","fit2","inf_individual","sup_individual")

highchart() %>% 
  hc_add_series(bd_pred,"scatter",hcaes(x=analfabetismo_2018,y=evida_2018,group=pais)) %>% 
  hc_legend() %>% 
  hc_add_series(bd_pred,"line",hcaes(x=analfabetismo_2018,y=fit),name="Regresión lineal",color="red") %>%  
  hc_add_series(bd_pred,"line",hcaes(x=analfabetismo_2018,y=inf_media),name="ICinf_media",color="#F97EF9") %>% 
  hc_add_series(bd_pred,"line",hcaes(x=analfabetismo_2018,y=sup_media),name="ICsup_media",color="#F97EF9") %>% 
  hc_add_series(bd_pred,"line",hcaes(x=analfabetismo_2018,y=inf_individual),name="ICinf_individual",color="blue") %>% 
  hc_add_series(bd_pred,"line",hcaes(x=analfabetismo_2018,y=sup_individual),name="ICsup_individual",color="blue") %>%
  hc_title(text="Análisis de Regresión del Analfabetismo y Esperanza de Vida") %>% 
  hc_subtitle(text="Países del Mundo 2018") %>% 
  hc_xAxis(title=list(text="Analfabetismo")) %>% 
  hc_yAxis(title=list(text="Esperanza de vida")) %>% 
  hc_add_theme(hc_theme_darkunica())
```


# Análisis de residuos

Los residuos son:

$$e_i=y_i-\hat y_i$$

Se puede considerar al residual como los errores aleatorios estimados de $\epsilon_i$.

En este análisis detectaremos:

* La relación lineal entre $X$ y $Y$.
* Normalidad de los errores.
* Valores anormales en la distribución de los errores.
* Varianza constante (propiedad de homocedasticidad).
* Independencia de los errores

## Normalidad de los residuos

El gráfico permite observar la normalidad de los errores y así del modelo.

```{r residuos}
bd_pred$residuales=residuals(mod)
bd_pred$res_estand=rstandard(mod)

highchart() %>% 
  hc_add_series(bd_pred,"scatter",hcaes(residuales,res_estand))
```


```{r}
plot(bd$analfabetismo_2018,bd$evida_2018)
```
















